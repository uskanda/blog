<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
    <link href="/stylesheets/gits.css" rel="stylesheet" />
    <link href="/stylesheets/syntax.css" rel="stylesheet" />
    <title>GHOST IN THE SUIT - Wordpressをnginx+fastcgiベースに移行した</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div class="header">
      <div class="container">
        <div class="row">
          <div class="col-sm-9">
            <h1 class="site_title">
              <a href="/">GHOST IN THE SUIT</a>
            </h1>
            <p>
              Excelの泥にまみれても、こころの奥にgeekの灯を。
            </p>
          </div>
          <div class="col-sm-3 hidden-xs externals">
            <a href="/feed.xml"><i class="fa fa-rss fa-3x"></i></a>
          </div>
        </div>
      </div>
    </div>
    <div class="container main">
      <div class="row">
        <div class="col-sm-9">
          <div id="main" role="main"><article>
  <div class="title">
    <a class="date" rel="bookmark"><abbr>2012/06</abbr>17<sub>00:00</sub></a>
    <div class="container">
      <div class="subject">Wordpressをnginx+fastcgiベースに移行した
      </div>
      <div class="tags">
        <div class="label label-primary">
          <i class="fa fa-tag"></i> nginx
        </div>
        <div class="label label-primary">
          <i class="fa fa-tag"></i> Ubuntu
        </div>
        <div class="label label-primary">
          <i class="fa fa-tag"></i> Server
        </div>
      </div>
    </div>
  </div>
  <div class="body"><p>旧さくらのVPS移行期限が近づいてきたので、急いでWordpressを新設したVPSに移行した。せっかくなのでnginxベースに。</p>

<p>WordPressは事前にWordPressディレクトリ内全ファイルをコピーしておく他、
データベースはすべてダンプし、移行先サーバに設置、インポートするだけ。データベースのダンプは
phpmyadminなどで行うか、wp-db-backup等のWordPressプラグインで行えばかんたん。</p>

<p>以下、Ubuntu 12.04での作業ログ。</p>

<p>nginx/php/fastcgiのインストール。<code>
aptitude install nginx php5-cli php5-cgi php5-gd spawn-fcgi</code></p>

<p>/usr/bin/以下に以下の内容でphp-fastcgiファイルを作成。
<code>
#!/bin/sh
/usr/bin/spawn-fcgi -a 127.0.0.1 -p 9000 -C 6 -u www-data -f /usr/bin/php5-cgi
</code></p>

<p>作成したファイルに実行権限付加。
<code>
cd /usr/bin/
chmod a+x php-fastcgi
</code></p>

<p>起動用スクリプト/etc/init.d/php-fastcgiを作成。</p>
<pre class="highlight text">\#!/bin/bash
PHP_SCRIPT=/usr/bin/php-fastcgi
FASTCGI_USER=www-data
RETVAL=0
case &quot;$1&quot; in
start)
su - $FASTCGI_USER -c $PHP_SCRIPT
RETVAL=$?
;;
stop)
killall -9 php5-cgi
RETVAL=$?
;;
restart)
killall -9 php5-cgi
su - $FASTCGI_USER -c $PHP_SCRIPT
RETVAL=$?
;;
*)
echo &quot;Usage: php-fastcgi {start|stop|restart}&quot;
exit 1
;;
esac
exit $RETVAL
console output
</pre>
<p>権限付加、自動起動設定してデーモン起動。
    chmod a+x /etc/init.d/php-fastcgi
    update-rc.d php-fastcgi defaults
    /etc/init.d/php-fastcgi start</p>

<p>nginxにWordpress用の設定を追加する。/etc/nginx/sites-available/wordpress に下記を追加。
    upstream php {
    server unix:/tmp/php-cgi.socket;
    server 127.0.0.1:9000;
    }</p>
<pre class="highlight text">server {
listen 80;
server_name your_domain_name;
access_log /var/log/nginx/wordpress.access.log;
error_log /var/log/nginx/wordpress.error.log;
root /path/to/wordpress/;
index index.php;
location = /favicon.ico {
log_not_found off;
access_log off;
}

location = /robots.txt {
allow all;
log_not_found off;
access_log off;
}

location / {
try_files $uri $uri/ /index.php;
}

location ~ \.php$ {
include /etc/nginx/fastcgi_params;
fastcgi_param SCRIPT_FILENAME /path/to/wordpress/$fastcgi_script_name;
fastcgi_intercept_errors on;
fastcgi_pass php;
}

location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
expires max;
log_not_found off;
}
}
</pre>
<p>作成した設定を有効化、fastcgi/nginxを起動。
<code>
ln -s /etc/nginx/sites-available/wordpress /etc/nginx/sites-enable/wordpress
/etc/init.d/php-fastcgi start
/etc/init.d/nginx start
</code>
<h2>参考サイト</h2>
<a href="http://iphone-diary.com/?p=9113">耐えられずにSixcoreサーバーへ移動 | 普通のサラリーマンのiPhone日記</a>
(Wordpressの移行)</p>

<p><a href="http://tjun.jp/blog/2011/09/nginx/">さくらVPS+ubuntu+wordpressにnginx入れたメモ | tjun memo</a></p>

<p><a href="http://wiki.nginx.org/WordPress">WordPress</a>
(nginx公式)</p>

<p><a href="http://akibe.com/wordpress%E7%94%A8%E3%81%AEnginx%E3%81%AE%E3%82%B5%E3%82%A4%E3%83%88%E8%A8%AD%E5%AE%9A%E3%82%92%E8%A6%8B%E7%9B%B4%E3%81%97/" target="_blank">Wordpress用のNginxのサイト設定を見直し @AKIBE</a></p>
<div class="social_buttons_bottom row">
      <div class="pull-left">
        <a class="twitter-share-button" data-count="vertical" data-lang="ja" data-related="anywhereTheJavascriptAPI" data-url="http://blog.uskanda.com/2012/06/17/wordpress-with-nginx/" data-via="uskanda" href="https://twitter.com/share">>ツイート</a></a>
        <script>
          !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
        </script>
      </div>
      <div class="pull-left">
        <a class="hatena-bookmark-button" data-hatena-bookmark-lang="ja" data-hatena-bookmark-layout="vertical-balloon" href="http://b.hatena.ne.jp/entry/blog.uskanda.com/2012/06/17/wordpress-with-nginx/" title="このエントリーをはてなブックマークに追加"><img alt="このエントリーをはてなブックマークに追加" height="20" src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a>
        <script async="async" charset="utf-8" src="http://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script>
      </div>
      <div class="pull-left">
        <a class="pocket-btn" data-lang="en" data-pocket-count="vertical" data-pocket-label="pocket" data-save-url="http://blog.uskanda.com/2012/06/17/wordpress-with-nginx/"></a>
        <script type="text/javascript">
          !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");
        </script>
      </div>
      <div class="pull-left">
        <div class="g-plusone" data-size="tall"></div>
        <script type="text/javascript">
          window.___gcfg = {lang: 'ja'};
          
          (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
          })();
        </script>
      </div>
      <div class="pull-left">
        <a class="feedlyButton" href="http://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Fblog.uskanda.com%2F" target="_blank" title="このブログのRSSをFeedlyで購読してみませんか">
          <div class="arrow_box_feedly">
            <i class="fa fa-rss fa-lg"></i>
          </div>
          <img alt="follow us in feedly" height="20" id="feedlyFollow" src="http://s3.feedly.com/img/follows/feedly-follow-rectangle-volume-medium_2x.png" width="66" /></a>
      </div>
    </div><h3>
      コメントをどうぞ 
    </h3>
    <div aria-live="polite" id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    <script type="text/javascript">
      var disqus_shortname = 'ghostinthesuit';
      var disqus_identifier = "http://blog.uskanda.com/2012/06/17/wordpress-with-nginx/";
      var disqus_url = 'http://blog.uskanda.com/2012/06/17/wordpress-with-nginx/';
      var disqus_script = 'embed.js';
      
      (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  </div>
</article>
          </div>
        </div>
        <div class="col-sm-3">
          <aside>
            <div class="gadget" id="recents">
              <span class="title">最近の投稿</span>
              <ol>
                <li>
                  <a href="/2013/12/18/capistrano-git-subdir/">Capistranoでgitレポジトリのサブディレクトリ以下をデプロイ対象にする(12/18)</a>
                </li>
                <li>
                  <a href="/2013/12/14/vim-set-relativenumber/">Vimのrelativenumber設定が便利すぎてヤバイ(12/14)</a>
                </li>
                <li>
                  <a href="/2013/12/10/middleman-blog-build-missed-some-article/">middleman-blogでbuildしたら何故か生成されない記事がある(12/10)</a>
                </li>
                <li>
                  <a href="/2013/12/09/transfer-from-octopress-to-middleman/">OctopressからMiddlemanに移行した(12/09)</a>
                </li>
                <li>
                  <a href="/2013/04/01/android-support-library-error-on-android-32/">Android3.2で通知を出そうとするとエラーが出る(04/01)</a>
                </li>
                <li>
                  <a href="/2013/02/23/mysql-show-columns-and-indices-from-all-the-tables/">MySQLで全てのテーブルのカラムとインデックス有無を表示したい(02/23)</a>
                </li>
                <li>
                  <a href="/2013/02/17/macbook-pro-cover/">MOBILE STUDIOのMacBook Proのマットブラック ハードケースを試す(02/17)</a>
                </li>
                <li>
                  <a href="/2013/02/17/buy-macbook-pro-refurbished/">整備済製品のMacBook Pro 13inch Retinaを買ってみた(02/17)</a>
                </li>
                <li>
                  <a href="/2013/01/31/hello-octopress/">今更ながらOctopress(01/31)</a>
                </li>
                <li>
                  <a href="/2013/01/04/vim-commands-for-me/">僕の覚えた順Vimコマンド(01/04)</a>
                </li>
              </ol>
            </div>
            <div class="gadget" id="adsense">
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <!-- BlogSide2 -->
              <ins class="adsbygoogle"
                   style="display:inline-block;width:200px;height:200px"
                   data-ad-client="ca-pub-1385530273298456"
                   data-ad-slot="9191807793"></ins>
              <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
              
            </div>
            <div class="gadget" id="tags">
              <span class="title">タグ一覧</span>
              <div class="gadget_body"><a href="/tags/ruby/">
                Ruby(5) </a><a href="/tags/emacs/">
                Emacs(4) </a><a href="/tags/ruby-on-rails/">
                Ruby on Rails(4) </a><a href="/tags/mac/">
                Mac(3) </a><a href="/tags/review/">
                Review(3) </a><a href="/tags/gadget/">
                Gadget(2) </a><a href="/tags/octopress/">
                Octopress(2) </a><a href="/tags/middleman/">
                Middleman(2) </a><a href="/tags/android/">
                Android(2) </a><a href="/tags/flash/">
                Flash(2) </a><a href="/tags/vim/">
                Vim(2) </a><a href="/tags/windows/">
                Windows(2) </a><a href="/tags/macbookpro/">
                MacBookPro(2) </a><a href="/tags/server/">
                Server(2) </a><a href="/tags/ubuntu/">
                Ubuntu(2) </a><a href="/tags/goo/">
                goo(1) </a><a href="/tags/rails/">
                Rails(1) </a><a href="/tags/rvm/">
                RVM(1) </a><a href="/tags/passenger/">
                Passenger(1) </a><a href="/tags/uc-411pbt-c/">
                UC-411PBT-C(1) </a><a href="/tags/nginx/">
                nginx(1) </a><a href="/tags/開発/">
                開発(1) </a><a href="/tags/rinari/">
                rinari(1) </a><a href="/tags/redmine/">
                redmine(1) </a><a href="/tags/refurbished/">
                Refurbished(1) </a><a href="/tags/adobe-air/">
                Adobe AIR(1) </a><a href="/tags/日々/">
                日々(1) </a><a href="/tags/mysql/">
                MySQL(1) </a><a href="/tags/capistrano/">
                Capistrano(1) </a><a href="/tags/git/">
                git(1) </a><a href="/tags/anything-el/">
                anything.el(1) </a><a href="/tags/actionscript/">
                Actionscript(1) </a><a href="/tags/book/">
                Book(1) </a><a href="/tags/mouse/">
                Mouse(1) </a><a href="/tags/logicool/">
                Logicool(1) </a><a href="/tags/macmini/">
                MacMini(1) </a><a href="/tags/ssd/">
                SSD(1) </a><a href="/tags/windows8/">
                Windows8(1) </a><a href="/tags/mediacenterpack/">
                MediaCenterPack(1) </a><a href="/tags/case/">
                Case(1) </a>
              </div>
            </div>
            <div class="gadget" id="twitter">
              <span class="title">ツイート</span><a class="twitter-timeline" data-chrome="noheader noborders transparent" data-widget-id="408280914938982400" href="https://twitter.com/uskanda">Tweets by @uskanda</a>
              <script>
                !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
              </script>
            </div>
            <div class="gadget" id="archives">
              <span class="title">アーカイブ</span>
              <ol class="year_archives"></ol>
              <li>
                <a href="/2013/">2013年</a> (10)
                <ol class="month_archives">
                  <li>
                    <a href="/2013/12/">2013年12月</a>(4)
                  </li>
                  <li>
                    <a href="/2013/04/">2013年4月</a>(1)
                  </li>
                  <li>
                    <a href="/2013/02/">2013年2月</a>(3)
                  </li>
                  <li>
                    <a href="/2013/01/">2013年1月</a>(2)
                  </li>
                </ol>
              </li>
              <li>
                <a href="/2012/">2012年</a> (14)
                <ol class="month_archives">
                  <li>
                    <a href="/2012/11/">2012年11月</a>(2)
                  </li>
                  <li>
                    <a href="/2012/09/">2012年9月</a>(1)
                  </li>
                  <li>
                    <a href="/2012/07/">2012年7月</a>(1)
                  </li>
                  <li>
                    <a href="/2012/06/">2012年6月</a>(5)
                  </li>
                  <li>
                    <a href="/2012/04/">2012年4月</a>(2)
                  </li>
                  <li>
                    <a href="/2012/03/">2012年3月</a>(1)
                  </li>
                  <li>
                    <a href="/2012/02/">2012年2月</a>(1)
                  </li>
                  <li>
                    <a href="/2012/01/">2012年1月</a>(1)
                  </li>
                </ol>
              </li>
              <li>
                <a href="/2011/">2011年</a> (8)
                <ol class="month_archives">
                  <li>
                    <a href="/2011/12/">2011年12月</a>(5)
                  </li>
                  <li>
                    <a href="/2011/11/">2011年11月</a>(1)
                  </li>
                  <li>
                    <a href="/2011/06/">2011年6月</a>(2)
                  </li>
                </ol>
              </li>
            </div>
            <div class="gadget" id="amazon">
              <script type="text/javascript"><!--
              amazon_ad_tag = "uasmks-22"; amazon_ad_width = "160"; amazon_ad_height = "600";//--></script>
              <script type="text/javascript" src="http://ir-jp.amazon-adsystem.com/s/ads.js"></script>
              
            </div>
          </aside>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="container">
        <div class="text-center">
          <style>
            .blogresponsivewide { width: 320px; height: 50px; }@media(min-width: 500px) { .blogresponsivewide { width: 468px; height: 60px; } }@media(min-width: 800px) { .blogresponsivewide { width: 728px; height: 90px; } }
          </style>
          <script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <ins class="adsbygoogle blogresponsivewide" data-ad-client="ca-pub-1385530273298456" data-ad-slot="4816571790" style="display:inline-block"></ins>
          <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
      </div>
      <div class="container blog_list">
        ブログ一覧
        <ul>
          <li>
            <a class="foreground_color" href="http://blog.uskanda.com/">GHOST IN THE SUIT - Web開発/サーバ/ガジェット等、IT系情報を中心に</a>
          </li>
          <li>
            <a class="foreground_color" href="http://blog.uskanda.com/cycle/">Homesick Cyclist - ロードバイク関連</a>
          </li>
          <li>
            <a class="foreground_color" href="http://blog.uskanda.com/greedy/">物欲遡及決裁 - 買っちゃったもののレビュー </a>
          </li>
        </ul>
      </div>
      <div class="container">
        <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license"><img alt="クリエイティブ・コモンズ・ライセンス" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" style="border-width:0" /></a>   Some rights reserved by Yusuke Kanda 2010-2013.
        <div class="pull-right">
          Powered by <a href="http://middlemanapp.com">Middleman</a>, <a href="http://github.com">Github</a>, <a href="https://travis-ci.org/">Travis CI</a>.  <img src="https://travis-ci.org/uskanda/blog.png?branch=master" />
        </div>
      </div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script><!-- Google Analytics -->
    <script type="text/javascript">
    
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3828545-4']);
      _gaq.push(['_setDomainName', 'uskanda.com']);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    
    </script>
    
  </body>
</html>